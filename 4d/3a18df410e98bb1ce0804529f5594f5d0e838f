changes since v3:

 - Implemented the simpler scheme suggested by Eric
